<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pi WiFi Setup</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 680px; margin: 40px auto; padding: 0 16px; }
    input, select, button { font-size: 16px; padding: 10px; width: 100%; margin: 8px 0; }
    button { cursor: pointer; }
    .row { margin: 16px 0; }
    .ok { color: #0a7; }
    .bad { color: #c22; }
    code { background: #f2f2f2; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>WiFi instellen</h1>
  <p>Kies je netwerk, vul het wachtwoord in en druk verbinden. Daarna verdwijnt het AP en gaat de Pi op jouw WiFi.</p>

  <div class="row">
    <button id="refresh">Scan netwerken</button>
    <select id="ssid"></select>
    <input id="password" type="password" placeholder="WiFi wachtwoord" />
    <button id="connect">Verbinden</button>
  </div>

  <div class="row" id="status"></div>

  <hr />
  <h2>Spotify</h2>
  <p>Na verbinding kun je Spotify streamen via <strong>Spotify Connect</strong>:
    open Spotify op je telefoon, ga naar <em>Beschikbare apparaten</em> en kies de Pi.
  </p>

<script>
const statusEl = document.getElementById('status');
const ssidEl = document.getElementById('ssid');
const passEl = document.getElementById('password');

function setStatus(msg, ok=true) {
  statusEl.className = ok ? 'ok' : 'bad';
  statusEl.textContent = msg;
}

async function refreshNetworks() {
  setStatus("Scannen...", true);
  const res = await fetch('/api/networks');
  const data = await res.json();
  ssidEl.innerHTML = '';
  (data.networks || []).forEach(n => {
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    ssidEl.appendChild(opt);
  });
  setStatus(`Gevonden: ${(data.networks || []).length} netwerken`, true);
}

async function connectWifi() {
  const ssid = ssidEl.value;
  const password = passEl.value;
  if (!ssid || !password) {
    setStatus("SSID en wachtwoord zijn verplicht.", false);
    return;
  }
  setStatus("Verbinden... (AP gaat zo uit)", true);
  const res = await fetch('/api/connect', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ssid, password})
  });
  const data = await res.json();
  if (!data.ok) {
    setStatus("Fout: " + (data.error || "onbekend"), false);
    return;
  }
  setStatus("Opgeslagen. De Pi probeert nu te verbinden. Daarna: http://spotibox.local:3001", true);
}

async function pollStatus() {
  try {
    const res = await fetch('/api/status');
    const data = await res.json();
    if (data.ssid) setStatus(`Verbonden met WiFi: ${data.ssid} (IP: ${data.ip || '?'})`, true);
  } catch {}
}

document.getElementById('refresh').addEventListener('click', refreshNetworks);
document.getElementById('connect').addEventListener('click', connectWifi);

refreshNetworks();
setInterval(pollStatus, 3000);
</script>
</body>
</html>
